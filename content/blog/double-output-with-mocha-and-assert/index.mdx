export const frontmatter = {
  title: "Double Output with Mocha and Assert",
  date: "2020-03-19",
  description:
    "A dive into testing with Node, garbage error messages, and what you can do about them.",
  unsplashPhoto: "https://images.unsplash.com/photo-1534368786749-b63e05c90863",
  unsplashPhotoLink: "https://unsplash.com/photos/4yOgRb_b_i4",
  unsplashPhotoAuthor: "J√∏rgen H√•land",
}

import strictEqual from "./strictEqual"
import equal from "./equal"
import strictEqualMochaOnly from "./strictEqual-mocha-only"
import equalMochaOnly from "./equal-mocha-only"
import strictEqualDiffOff from "./strictEqual-diff-off"

If you use [Mocha][mocha] and Node.js [`assert`][assert] you may have become used to seeing test failures like this.

<Terminal>{strictEqual}</Terminal>

In fact, you‚Äôre probably so used to seeing this that you don‚Äôt even notice the three things that are wrong with it.

1. The error message/diff is displayed twice
2. One of the messages is weirdly outdented
3. The ordering and color of ‚Äúactual‚Äù and ‚Äúexpected‚Äù between the messages are inexplicably _both_ inverted

Now that you‚Äôve seen it you can‚Äôt unsee it üôà It had been bugging me for a long time and I finally decided to get to the bottom of it. Here‚Äôs what I found.

---

This is the test that generated that output.

```js
it("assert.strictEqual", () => {
  assert.strictEqual("foofoo", "barbar")
})
```

When exploring a problem I try to change small things one at a time to see what happens. So let‚Äôs change `assert.strictEqual` to `assert.equal`.

```js{2}
it("assert.equal", () => {
  assert.equal("foofoo", "barbar")
})
```

<Terminal>{equal}</Terminal>

That output looks more like what you‚Äôd expect. Concise and indented correctly. But I would not have expected that to make a difference. What‚Äôs going on here?

To figure it out, let‚Äôs catch the errors we‚Äôre creating with the assertions and introspect the error objects themselves.

```js{2,4-6,10,12-14}
it("assert.strictEqual", () => {
  try {
    assert.equal("foofoo", "barbar")
  } catch (error) {
    console.log(error)
  }
})

it("assert.strictEqual with shorter strings", () => {
  try {
    assert.strictEqual("foo", "bar")
  } catch (error) {
    console.log(error)
  }
})
```

This is the log from `assert.strictEqual`.

```
AssertionError [ERR_ASSERTION]: Expected values to be strictly equal:
+ actual - expected

+ 'foofoo'
- 'barbar'

{
  generatedMessage: true,
  code: 'ERR_ASSERTION',
  actual: 'foofoo',
  expected: 'barbar',
  operator: 'strictEqual'
}
```

And this is the log from `assert.equal`.

```
AssertionError [ERR_ASSERTION]: 'foofoo' == 'barbar'

{
  generatedMessage: true,
  code: 'ERR_ASSERTION',
  actual: 'foofoo',
  expected: 'barbar',
  operator: '=='
}
```

I‚Äôve massaged the output a little bit to make it easier to understand what‚Äôs going on.

First you can see an error ‚Äúmessage‚Äù. Then you can see the properties of the `Error` class. The properties are used by the `Error` class to generate the error message.

If we go back to our Mocha output and subtract the error messages we‚Äôre left with this.

<Terminal>{strictEqualMochaOnly}</Terminal>
<Terminal>{equalMochaOnly}</Terminal>

Now the output is effectively identical. I think I‚Äôm finally starting to see the shape of what happened here.

The remaining output must be generated by Mocha. In the same way that the `Error` class uses its properties to generate a useful error message, Mocha also uses those properties to make a helpful ‚Äúdiff‚Äù of the actual and expected values.

This helps us partially answer our question. The reason why the output is ‚Äúdoubled‚Äù when using `assert.strictEqual` is because the output is coming from two different places: some from `assert` and some from Mocha.

But then the question becomes ‚ÄúHow did we end up here?‚Äù because showing two diffs makes absolutely no sense.

`assert.equal` and `assert.strictEqual` have both been part of Node from the very beginning, so you‚Äôd think their output would be identical‚Äîthey‚Äôre just different ways of asserting equality. Let‚Äôs go spelunking in the Node codebase to see what‚Äôs going on.

The error message gets generated in the [`AssertionError`][assertion-error] class. Here‚Äôs the [relevant spot][conditional].

```js
if (operator === 'deepStrictEqual' || operator === 'strictEqual') {
  super(createErrDiff(actual, expected, operator));
```

`assert.strictEqual` is being handled differently from `assert.equal` when the error message is generated and gets a special diff. Has it always been that way?

If you spin your way back through the commit history you‚Äôll eventually find this [pull request][pull-request] from late 2017 with this abridged description.

> The current assert errors are actually pretty bad when it comes to objects. This implements a simple way to add diffs as default but only in assert strict mode.
>
> ‚Ä¶
>
> Activating the diff always would mean we have to change all our assert tests and I did not want to do that, besides the fact that some people might partially rely on the message output.

So basically what happened here is Node used to have mediocre error messages and so test frameworks like Mocha generated additional information to make debugging easier.

Then a few years ago someone improved Node‚Äôs error messages but only for strict assertions. I think that‚Äôs pretty confusing but in fairness to them, non-strict assertions _are_ deprecated and you‚Äôre not supposed to use them.

So that‚Äôs it. The reason why Mocha‚Äôs test output looks like garbage with `assert` is because about 8 years after Node and Mocha were created the implementation of `assert` changed.

That‚Äôs unfortunate. Now that we know the reason, what can we do about it?

The solution is painfully simple but I think it doesn‚Äôt become clear what it is until you understand what changed and why.

Mocha‚Äôs diffing is configurable. It defaults to on but we need to turn it off and let `assert` handle the diffing.

Run the `mocha` command with `--diff false` or set it in your config.

```js
// .mocharc.js

module.exports = {
  diff: false,
}
```

This is what the output looks like now.

<Terminal>{strictEqualDiffOff}</Terminal>

That‚Äôs definitely an improvement, although the error message is still outdented grossly. Unfortunately fixing the indentation has no easy, direct solution. Ideally this would be fixed in Mocha, but you‚Äôd have to fix every single Mocha reporter and that could necessitate some breaking or undesirable changes to the output.

The only alternative is to use a different assertion library. The biggest improvement for the least amount of effort is probably [Power Assert][power-assert].

Power Assert has an interface that looks like `assert` but with truly next-level error messages. Here are two examples from the docs.

```
assert(ary.indexOf(zero) === two)
        |   |       |     |   |
        |   |       |     |   2
        |   -1      0     false
        [1,2,3]
```

```
assert(types[index].name === bob.name)
        |    ||      |    |   |   |
        |    ||      |    |   |   "bob"
        |    ||      |    |   Person{name:"bob",age:5}
        |    ||      |    false
        |    |11     "alice"
        |    Person{name:"alice",age:3}
        ["string",98.6,true,false,null,undefined,#Array#,#Object#,NaN,Infinity,/^not/,#Person#]
```

Yeah ü§Ø I didn‚Äôt even know how badly I needed this until I saw it for the first time.

The way Power Assert is implemented it uses transpilation to enhance `assert`, so you can use it without having to change your test suite at all. You can just [install](https://github.com/power-assert-js/power-assert#example) it and immediately start getting better error messages!

[mocha]: https://mochajs.org
[assert]: https://nodejs.org/api/assert.html
[assertion-error]: https://github.com/nodejs/node/blob/7a742ec050222dfabfa8fca07167a3b2c680fb3c/lib/internal/assert/assertion_error.js
[conditional]: https://github.com/nodejs/node/blob/7a742ec050222dfabfa8fca07167a3b2c680fb3c/lib/internal/assert/assertion_error.js#L355-L356
[pull-request]: https://github.com/nodejs/node/pull/17615
[power-assert]: https://github.com/power-assert-js/power-assert
